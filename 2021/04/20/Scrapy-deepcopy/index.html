<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Scrapy deepcopy - BakaFT&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="BakaFT&#039;s blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="BakaFT&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Why write this postThe code: 123456789101112def parse_category(self, response):    flower &amp;#x3D; FlowerItem()    root &amp;#x3D; response.css(&amp;quot;div.zhiwuImg&amp;quot;)    for li in root.css(&amp;quot;li&amp;quot;):"><meta property="og:type" content="blog"><meta property="og:title" content="Scrapy deepcopy"><meta property="og:url" content="https://bakaft.github.io/2021/04/20/Scrapy-deepcopy/"><meta property="og:site_name" content="BakaFT&#039;s blog"><meta property="og:description" content="Why write this postThe code: 123456789101112def parse_category(self, response):    flower &amp;#x3D; FlowerItem()    root &amp;#x3D; response.css(&amp;quot;div.zhiwuImg&amp;quot;)    for li in root.css(&amp;quot;li&amp;quot;):"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://bakaft.github.io/img/og_image.png"><meta property="article:published_time" content="2021-04-20T22:24:43.000Z"><meta property="article:modified_time" content="2023-12-28T08:42:40.251Z"><meta property="article:author" content="BakaFT"><meta property="article:tag" content="Python"><meta property="article:tag" content="Scrapy"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://bakaft.github.io/2021/04/20/Scrapy-deepcopy/"},"headline":"Scrapy deepcopy","image":["https://bakaft.github.io/img/og_image.png"],"datePublished":"2021-04-20T22:24:43.000Z","dateModified":"2023-12-28T08:42:40.251Z","author":{"@type":"Person","name":"BakaFT"},"publisher":{"@type":"Organization","name":"BakaFT's blog","logo":{"@type":"ImageObject","url":{"text":"BakaFT's blog"}}},"description":"Why write this postThe code: 123456789101112def parse_category(self, response):    flower &#x3D; FlowerItem()    root &#x3D; response.css(&quot;div.zhiwuImg&quot;)    for li in root.css(&quot;li&quot;):"}</script><link rel="canonical" href="https://bakaft.github.io/2021/04/20/Scrapy-deepcopy/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/highlight.js@9.12.0/styles/idea.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://fastly.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 6.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">BakaFT&#039;s blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-04-20T22:24:43.000Z" title="4/20/2021, 10:24:43 PM">2021-04-20</time></span></div></div><h1 class="title is-3 is-size-4-mobile">Scrapy deepcopy</h1><div class="content"><h1 id="Why-write-this-post"><a href="#Why-write-this-post" class="headerlink" title="Why write this post"></a>Why write this post</h1><p>The code:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">parse_category</span>(<span class="params">self, response</span>):</span><br><span class="line">    flower = FlowerItem()</span><br><span class="line">    root = response.css(<span class="string">&quot;div.zhiwuImg&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> li <span class="keyword">in</span> root.css(<span class="string">&quot;li&quot;</span>):</span><br><span class="line">        flower[<span class="string">&quot;name&quot;</span>] = li.css(<span class="string">&quot;img&quot;</span>).attrib[<span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(url=self.webroot+li.css(<span class="string">&quot;a:first-child::attr(href)&quot;</span>).get(), meta=&#123;<span class="string">&quot;item&quot;</span>:flower&#125;, callback=self.parse_detail)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_detail</span>(<span class="params">self, response</span>):</span><br><span class="line">    flower = response.meta[<span class="string">&#x27;item&#x27;</span>]</span><br><span class="line">    root = response.css(<span class="string">&quot;div.contentDiv&quot;</span>)</span><br><span class="line">    flower[<span class="string">&#x27;firstletter&#x27;</span>] = root.css(<span class="string">&quot;blockquote p::text&quot;</span>).get()</span><br><span class="line">    <span class="keyword">yield</span> flower</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p>I am using <code>scrapy.Request</code> and set two attributes from two pages by pass a <code>meta</code> argument  </p>
<p>and the expected result when I execute </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl mySpider -o res.json</span><br></pre></td></tr></table></figure>

<p>should be like:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Alpha&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;quote&quot;</span><span class="punctuation">:</span><span class="string">&quot;A&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Beta&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;quote&quot;</span><span class="punctuation">:</span><span class="string">&quot;B&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Zeta&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;quote&quot;</span><span class="punctuation">:</span><span class="string">&quot;Z&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>but in fact what’s in <code>res.json</code> is like:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Alpha&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;quote&quot;</span><span class="punctuation">:</span><span class="string">&quot;A&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Alpha&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;quote&quot;</span><span class="punctuation">:</span><span class="string">&quot;B&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Alpha&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;quote&quot;</span><span class="punctuation">:</span><span class="string">&quot;Z&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>This is wired cuz my code is logical superficially  but can’t figure it out </p>
<p>until I searched on Internet…That’s a very common question when it comes to  High-level programming language like Python:</p>
<p>The difference between <code>Value Type</code> and <code>Reference Type</code></p>
<h1 id="What’s-Copy-in-Python"><a href="#What’s-Copy-in-Python" class="headerlink" title="What’s Copy in Python"></a>What’s Copy in Python</h1><p>Think about this python code, what’s the output?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python</span></span><br><span class="line">a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">b = a</span><br><span class="line">b.append(<span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br></pre></td></tr></table></figure>

<p>Surely in python it’s <code>[1,2,3,4]</code>. But what you changed is b, why a was changed too?</p>
<p>That’s because in Python <code>a</code> and <code>b</code> is two <code>pointer</code>(just like C programming) pointing the same memory address(which is called <code>id</code> in python)</p>
<blockquote>
<h4 id="Copying-items"><a href="#Copying-items" class="headerlink" title="Copying items"></a>Copying items</h4><p>To copy an item, you must first decide whether you want a shallow copy or a deep copy.</p>
<p>If your item contains <a target="_blank" rel="noopener" href="https://docs.python.org/3/glossary.html#term-mutable">mutable</a> values like lists or dictionaries, a shallow copy will keep references to the same mutable values across all different copies.</p>
<p>For example, if you have an item with a list of tags, and you create a shallow copy of that item, both the original item and the copy have the same list of tags. Adding a tag to the list of one of the items will add the tag to the other item as well.</p>
<p><strong>If that is not the desired behavior, use a deep copy instead.</strong></p>
</blockquote>
<h1 id="Back-to-the-start"><a href="#Back-to-the-start" class="headerlink" title="Back to the start"></a>Back to the start</h1><p>From the <code>Scrapy document</code> we can know about <code>meta</code>:</p>
<blockquote>
<p>A dict that contains arbitrary metadata for this request. This dict is empty for new Requests, and is usually populated by different Scrapy components (extensions, middlewares, etc). So the data contained in this dict depends on the extensions you have enabled.</p>
<p>See <a target="_blank" rel="noopener" href="https://doc.scrapy.org/en/latest/topics/request-response.html#topics-request-meta">Request.meta special keys</a> for a list of special meta keys recognized by Scrapy.</p>
<p><strong>This dict is <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/copy.html">shallow copied</a> when the request is cloned using the <code>copy()</code> or <code>replace()</code> methods, and can also be accessed, in your spider, from the <code>response.meta</code> attribute.</strong></p>
</blockquote>
<p>And so does it when it’s being passed like</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">yield</span> scrapy.Request(meta=&#123;<span class="string">&quot;item&quot;</span>:flower&#125;, callback=self.parse_detail)</span><br></pre></td></tr></table></figure>

<p><code>Scrapy</code> is asynchronous by default, which means when your code looks like it’s logical, but it will probably not work as you wish.</p>
<p>So a easy way to avoid that is to <code>deepcopy</code> this item, namely duplicating it in the memory, not pointing:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">yield</span> scrapy.Request(meta=&#123;<span class="string">&quot;item&quot;</span>:deepcopy(flower)&#125;, callback=self.parse_detail)</span><br></pre></td></tr></table></figure>

<p>Reference given by @Gallecio:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/scrapy/scrapy/issues/3194">https://github.com/scrapy/scrapy/issues/3194</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Scrapy deepcopy</p><p><a href="https://bakaft.github.io/2021/04/20/Scrapy-deepcopy/">https://bakaft.github.io/2021/04/20/Scrapy-deepcopy/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>BakaFT</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-04-20</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2023-12-28</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Python/">Python</a><a class="link-muted mr-2" rel="tag" href="/tags/Scrapy/">Scrapy</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/04/24/Hackintiosh-on-HASEE-ZX6-CT5DA/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Hackintiosh on HASEE_ZX6_CT5DA</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/10/24/Bilibili%20CTF/"><span class="level-item">Bilibili CTF WriteUP</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Why-write-this-post"><span class="level-left"><span class="level-item">1</span><span class="level-item">Why write this post</span></span></a></li><li><a class="level is-mobile" href="#What’s-Copy-in-Python"><span class="level-left"><span class="level-item">2</span><span class="level-item">What’s Copy in Python</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Copying-items"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">Copying items</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Back-to-the-start"><span class="level-left"><span class="level-item">3</span><span class="level-item">Back to the start</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">BakaFT&#039;s blog</a><p class="is-size-7"><span>&copy; 2023 BakaFT</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://fastly.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://fastly.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://fastly.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://fastly.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://fastly.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://fastly.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>