<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>6.828-Hw1-Boot xv6 - BakaFT&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="BakaFT&#039;s blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="BakaFT&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Homework: boot xv6Exercise: What is on the stackBegin by restarting qemu and gdb, and set a break-point at 0x7c00, the start of the boot block (bootasm.S). Single step through the instructions (type s"><meta property="og:type" content="blog"><meta property="og:title" content="6.828-Hw1-Boot xv6"><meta property="og:url" content="https://bakaft.github.io/2021/11/02/6-828-Hw1/"><meta property="og:site_name" content="BakaFT&#039;s blog"><meta property="og:description" content="Homework: boot xv6Exercise: What is on the stackBegin by restarting qemu and gdb, and set a break-point at 0x7c00, the start of the boot block (bootasm.S). Single step through the instructions (type s"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://bakaft.github.io/img/og_image.png"><meta property="article:published_time" content="2021-11-02T21:44:16.000Z"><meta property="article:modified_time" content="2023-12-28T08:42:40.251Z"><meta property="article:author" content="BakaFT"><meta property="article:tag" content="OS"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://bakaft.github.io/2021/11/02/6-828-Hw1/"},"headline":"6.828-Hw1-Boot xv6","image":["https://bakaft.github.io/img/og_image.png"],"datePublished":"2021-11-02T21:44:16.000Z","dateModified":"2023-12-28T08:42:40.251Z","author":{"@type":"Person","name":"BakaFT"},"publisher":{"@type":"Organization","name":"BakaFT's blog","logo":{"@type":"ImageObject","url":{"text":"BakaFT's blog"}}},"description":"Homework: boot xv6Exercise: What is on the stackBegin by restarting qemu and gdb, and set a break-point at 0x7c00, the start of the boot block (bootasm.S). Single step through the instructions (type s"}</script><link rel="canonical" href="https://bakaft.github.io/2021/11/02/6-828-Hw1/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/highlight.js@9.12.0/styles/idea.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://fastly.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 6.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">BakaFT&#039;s blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-11-02T21:44:16.000Z" title="11/2/2021, 9:44:16 PM">2021-11-02</time></span></div></div><h1 class="title is-3 is-size-4-mobile">6.828-Hw1-Boot xv6</h1><div class="content"><h2 id="Homework-boot-xv6"><a href="#Homework-boot-xv6" class="headerlink" title="Homework: boot xv6"></a>Homework: boot xv6</h2><h2 id="Exercise-What-is-on-the-stack"><a href="#Exercise-What-is-on-the-stack" class="headerlink" title="Exercise: What is on the stack"></a>Exercise: What is on the stack</h2><p><strong>Begin by restarting qemu and gdb, and set a break-point at 0x7c00, the start of the boot block (bootasm.S). Single step through the instructions (type <code>si</code> at the gdb prompt). Where in bootasm.S is the stack pointer initialized? (Single step until you see an instruction that moves a value into <code>%esp</code>, the register for the stack pointer.)</strong></p>
<span id="more"></span>
<p>It’s at</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Set up the stack pointer and call into C.</span><br><span class="line">=&gt; 0x7c43:	mov    $0x7c00,%esp</span><br></pre></td></tr></table></figure>

<p><strong>Single step through the call to <code>bootmain</code>; what is on the stack now?</strong></p>
<p>Before we call <code>bootmain</code>,  ESP still points where the boot loader starts.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b*0x7c48</span><br><span class="line">Breakpoint 1 at 0x7c48</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">The target architecture is assumed to be i386</span><br><span class="line">=&gt; 0x7c48:	call   0x7d2a</span><br><span class="line">(gdb) x/24x $esp</span><br><span class="line">0x7c00:	0x8ec031fa	0x8ec08ed8	0xa864e4d0	0xb0fa7502</span><br><span class="line">0x7c10:	0xe464e6d1	0x7502a864	0xe6dfb0fa	0x16010f60</span><br><span class="line">0x7c20:	0x200f7c78	0xc88366c0	0xc0220f01	0x087c31ea</span><br><span class="line">0x7c30:	0x10b86600	0x8ed88e00	0x66d08ec0	0x8e0000b8</span><br><span class="line">0x7c40:	0xbce88ee0	0x00007c00	0x0000dde8	0x00b86600</span><br><span class="line">0x7c50:	0xc289668a	0xb866ef66	0xef668ae0	0x9066feeb</span><br></pre></td></tr></table></figure>

<p>Then step into <code>bootmain</code>. Now the first and only element on stack is <code>0x00007c4d</code>. From <code>bootblock.asm</code>, we can know that This is where the <code>bootmain</code> returns. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) si</span><br><span class="line">=&gt; 0x7d2a:	push   %ebp</span><br><span class="line">0x00007d2a in ?? ()</span><br><span class="line">(gdb) x/24x $esp</span><br><span class="line">0x7bfc:	0x00007c4d	0x8ec031fa	0x8ec08ed8	0xa864e4d0</span><br><span class="line">0x7c0c:	0xb0fa7502	0xe464e6d1	0x7502a864	0xe6dfb0fa</span><br><span class="line">0x7c1c:	0x16010f60	0x200f7c78	0xc88366c0	0xc0220f01</span><br><span class="line">0x7c2c:	0x087c31ea	0x10b86600	0x8ed88e00	0x66d08ec0</span><br><span class="line">0x7c3c:	0x8e0000b8	0xbce88ee0	0x00007c00	0x0000dde8</span><br><span class="line">0x7c4c:	0x00b86600	0xc289668a	0xb866ef66	0xef668ae0</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># If bootmain returns (it shouldn&#x27;t), trigger a Bochs</span><br><span class="line"># breakpoint if running under Bochs, then loop.</span><br><span class="line">movw    $0x8a00, %ax            # 0x8a00 -&gt; port 0x8a00</span><br><span class="line">7c4d:	66 b8 00 8a          	mov    $0x8a00,%ax</span><br></pre></td></tr></table></figure>

<p>This shows  <strong><code>call</code> will also modify <code>%ESP</code>, pushing the return address into the stack.</strong></p>
<p>Continue to run till <code>0x7d30</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) si</span><br><span class="line">=&gt; 0x7d30:	sub    $0x2c,%esp</span><br><span class="line">0x00007d30 in ?? ()</span><br><span class="line">(gdb) x/24x $esp</span><br><span class="line">0x7bec:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x7bfc:	0x00007c4d	0x8ec031fa	0x8ec08ed8	0xa864e4d0</span><br><span class="line">0x7c0c:	0xb0fa7502	0xe464e6d1	0x7502a864	0xe6dfb0fa</span><br><span class="line">0x7c1c:	0x16010f60	0x200f7c78	0xc88366c0	0xc0220f01</span><br><span class="line">0x7c2c:	0x087c31ea	0x10b86600	0x8ed88e00	0x66d08ec0</span><br><span class="line">0x7c3c:	0x8e0000b8	0xbce88ee0	0x00007c00	0x0000dde8</span><br></pre></td></tr></table></figure>

<p>That corresponds to this asm code</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">7d2a:	55                   	push   %ebp</span><br><span class="line">7d2b:	89 e5                	mov    %esp,%ebp</span><br><span class="line">7d2d:	57                   	push   %edi</span><br><span class="line">7d2e:	56                   	push   %esi</span><br><span class="line">7d2f:	53                   	push   %ebx</span><br></pre></td></tr></table></figure>

<p>We can know that the stack are like this in memory:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">VALUE                 										ADDRESS</span><br><span class="line">0x0(EBX)                      						        0x7bec(ESP)</span><br><span class="line">0x0(ESI)                      						        0x7bf0(ESP+4)</span><br><span class="line">0x0(EDI)                    						        0x7bf4(ESP+8)</span><br><span class="line">0x0(EBP)                      						        0x7bf8(ESP+12)</span><br><span class="line">0x7c4d(Return address)                                      0x7bfc(ESP+16)</span><br></pre></td></tr></table></figure>

<p><strong>What do the first assembly instructions of bootmain do to the stack? Look for bootmain in bootblock.asm.</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=&gt; 0x7d2a: 	push   %ebp</span><br></pre></td></tr></table></figure>

<p>Push <code>%ebp</code> into the stack</p>
<p><strong>Continue tracing via gdb (using breakpoints if necessary – see hint below) and look for the call that changes <code>eip</code> to 0x10000c. What does that call do to the stack? (Hint: Think about what this call is trying to accomplish in the boot sequence and try to identify this point in bootmain.c, and the corresponding instruction in the bootmain code in bootblock.asm. This might help you set suitable breakpoints to speed things up.)</strong></p>
<p>It’s at <code>0x7db2</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=&gt; 0x7db2: call   *0x10018</span><br></pre></td></tr></table></figure>

<p>In <code>bootmain.c</code> it’s <code>entry()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">elf = (<span class="keyword">struct</span> elfhdr*)<span class="number">0x10000</span>;  <span class="comment">// scratch space</span></span><br><span class="line"><span class="comment">//....</span></span><br><span class="line"><span class="comment">// Call the entry point from the ELF header.</span></span><br><span class="line"><span class="comment">// Does not return!</span></span><br><span class="line">entry = (<span class="type">void</span>(*)(<span class="type">void</span>))(elf-&gt;entry);</span><br><span class="line">entry();</span><br></pre></td></tr></table></figure>

<p>From <code>elf.h</code> we can know How did we get <code>0x10018</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File header</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">elfhdr</span> &#123;</span></span><br><span class="line">uint magic;  <span class="comment">// must equal ELF_MAGIC</span></span><br><span class="line">uchar elf[<span class="number">12</span>];</span><br><span class="line">ushort type;</span><br><span class="line">ushort machine;</span><br><span class="line">uint version;</span><br><span class="line">uint entry;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	uint = unsigned int = 4 Bytes</span></span><br><span class="line"><span class="comment">	ushort = unsigned short = 1 Byte</span></span><br><span class="line"><span class="comment">	uchar = unsigned char = 2 Byte</span></span><br><span class="line"><span class="comment">/*</span></span><br></pre></td></tr></table></figure>

<p><code>0x10000</code>  + 4 + C + 2 + 2 + 4 &#x3D; <code>0x10018</code> </p>
<p>What on <code>0x10018</code>  is the destination of <code>call</code> , also the value to be set on <code>%eip</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/x 0x10018</span><br><span class="line">0x10018:	0x0010000c</span><br></pre></td></tr></table></figure>

<p>That’s why next step we are at <code>0x10000c</code></p>
<p>From previous question, we’ve already noticed that  <strong><code>call</code> will also modify <code>%ESP</code>, pushing the return address into the stack.</strong></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>6.828-Hw1-Boot xv6</p><p><a href="https://bakaft.github.io/2021/11/02/6-828-Hw1/">https://bakaft.github.io/2021/11/02/6-828-Hw1/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>BakaFT</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-11-02</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2023-12-28</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/OS/">OS</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/11/04/6-828-Hw2-Shell/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">6.828-Hw2-Shell</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/11/02/PC%E7%95%8C%E4%B8%AD%E6%8C%87%E4%BB%A4%E9%9B%86%E6%9E%B6%E6%9E%84%E7%9A%84%E7%A7%B0%E5%91%BC%E4%B8%8E%E5%8C%BA%E5%88%AB/"><span class="level-item">PC界中指令集架构的称呼与区别</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><div class="column column-right is-4-tablet is-4-desktop is-4-widescreen  order-3"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Homework-boot-xv6"><span class="level-left"><span class="level-item">1</span><span class="level-item">Homework: boot xv6</span></span></a></li><li><a class="level is-mobile" href="#Exercise-What-is-on-the-stack"><span class="level-left"><span class="level-item">2</span><span class="level-item">Exercise: What is on the stack</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">BakaFT&#039;s blog</a><p class="is-size-7"><span>&copy; 2023 BakaFT</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://fastly.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://fastly.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://fastly.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://fastly.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://fastly.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://fastly.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>